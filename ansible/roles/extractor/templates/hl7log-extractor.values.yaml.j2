image:
  repository: '{{ hl7log_extractor_image_repository }}'
  tag: '{{ hl7log_extractor_image_tag }}'
{% if aws_deployment %}
serviceAccount:
  create: false
  automount: true
  name: 'lake-writer'
{% endif %}

envFrom:
{% if not aws_deployment %}
  - secretRef:
      name: s3-secret
{% endif %}
  - configMapRef:
      name: s3-env
env:
  - name: TZ
    value: '{{ hl7log_extractor_timezone }}'
  - name: JAVA_TOOL_OPTIONS
    value: '-XX:MaxRAMPercentage={{ hl7log_extractor_jvm_heap_max_ram_percentage }} -XX:+UseContainerSupport'
service:
  type: ClusterIP
  port: 8080
resources: {{ hl7log_extractor_resources | to_json }}
volumes:
  - name: data
{% if aws_deployment %}
    emptyDir: {}
{% else %}
    hostPath:
      path: '{{ extractor_data_dir }}'
{% endif %}
volumeMounts:
  - name: data
    mountPath: /data
    readOnly: true
{% if not aws_deployment %}
    mountPropagation: HostToContainer
{% endif %}
{% if aws_deployment and s3_sync_enabled %}
sidecar:
  enabled: true
  image:
    repository: '{{ s3_syncer_image_repository }}'
    tag: '{{ s3_syncer_image_tag }}'
    pullPolicy: IfNotPresent
  env:
    - name: S3_SOURCE_BUCKET
      value: '{{ s3_sync_source_bucket }}'
    - name: S3_SOURCE_PREFIX
      value: '{{ s3_sync_source_prefix }}'
    - name: SYNC_DESTINATION
      value: /data
    - name: SYNC_INTERVAL
      value: '{{ s3_sync_interval_seconds }}'
    - name: SYNC_DELETE
      value: '{{ s3_sync_delete }}'
    - name: SYNC_MODE
      value: '{{ s3_sync_mode }}'
  volumeMounts:
    - name: data
      mountPath: /data
  resources:
    requests:
      memory: '{{ s3_syncer_memory_request }}'
      cpu: '{{ s3_syncer_cpu_request }}'
    limits:
      memory: '{{ s3_syncer_memory_limit }}'
      cpu: '{{ s3_syncer_cpu_limit }}'
  securityContext:
    allowPrivilegeEscalation: false
{% else %}
sidecar:
  enabled: false
{% endif %}
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: 8080
  initialDelaySeconds: 15
  periodSeconds: 10
config:
  application:
    management:
      metrics:
        tags:
          namespace: '{{ extractor_namespace }}'
    s3:
      region: '{{ s3_region }}'
      endpoint: '{{ s3_endpoint }}'
    spring:
      datasource:
        url: '{{ jdbc_url }}/{{ ingest_postgres_table_name }}'
        username: '{{ postgres_user }}'
        password: '{{ postgres_password }}'
      temporal:
        connection:
          target: 'temporal-internal-frontend.{{ scout_extractor_namespace }}:7236'
    scout:
      workflowArgDefaults:
        ingestHl7Log:
          logsRootPath: '{{ hl7logs_root_dir }}'
          scratchSpaceRootPath: '{{ scratch_path }}'
          hl7OutputPath: '{{ hl7_path }}'
          splitAndUploadTimeout: {{ hl7log_extractor_timeout | default(480) }}
          splitAndUploadHeartbeatTimeout: {{ hl7log_extractor_heartbeat_timeout | default(30) }}
          splitAndUploadConcurrency: {{ hl7log_extractor_concurrency | default(150) }}
        ingestHl7ToDeltaLake:
          deltaIngestTimeout: {{ hl7_transformer_timeout | default(60) }}
          reportTableName: '{{ report_delta_table_name }}'
