---
# Default values for MinIO deployment

# Namespace configuration
minio_tenant_name: scout

# Storage configuration
minio_storage_size: 10Gi
minio_storage_class: ''

# Resource configuration (dev defaults - CI friendly)
minio_resources:
  requests:
    cpu: 100m
    memory: 1Gi
  limits:
    cpu: 2
    memory: 2Gi

# Environment variables
minio_env_secret_name: minio-scout-env-configuration
minio_env_variables:
  - name: MINIO_BROWSER_REDIRECT_URL
    value: 'https://minio.{{ server_hostname }}'
  - name: MINIO_PROMETHEUS_AUTH_TYPE
    value: public
  - name: MINIO_SCANNER_SPEED
    value: slowest

# Ingress configuration
minio_ingress_config_aws:
  console:
    enabled: true
    ingressClassName: alb
    host: 'minio.{{ server_hostname }}'
    path: '/'
    pathType: Prefix
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/auth-type: oidc
      alb.ingress.kubernetes.io/auth-idp-oidc: '{"issuer":"{{ keycloak_realm_url }}","authorizationEndpoint":"{{ keycloak_oidc_auth_url }}","tokenEndpoint":"{{ keycloak_oidc_token_url }}","userInfoEndpoint":"{{ keycloak_oidc_userinfo_url }}","clientId":"{{ keycloak_minio_client_id }}","clientSecret":"{{ keycloak_minio_client_secret }}"}'
      alb.ingress.kubernetes.io/auth-on-unauthenticated-request: authenticate
      alb.ingress.kubernetes.io/auth-scope: 'openid microprofile-jwt'
      alb.ingress.kubernetes.io/auth-session-cookie: AWSELBAuthSessionCookie
      alb.ingress.kubernetes.io/auth-session-timeout: '3600'

minio_ingress_config_onprem:
  console:
    enabled: true
    ingressClassName: traefik
    host: 'minio.{{ server_hostname }}'
    path: '/'
    pathType: Prefix
    annotations:
      traefik.ingress.kubernetes.io/router.middlewares: >
        kube-system-oauth2-proxy-error@kubernetescrd,
        kube-system-oauth2-proxy-auth@kubernetescrd

minio_ingress_config: '{{ minio_ingress_config_aws if aws_deployment else minio_ingress_config_onprem }}'

# Bucket definitions
minio_buckets:
  - name: '{{ loki_chunks_bucket }}'
  - name: '{{ loki_ruler_bucket }}'
  - name: '{{ loki_admin_bucket }}'
  - name: '{{ lake_bucket }}'
  - name: '{{ scratch_bucket }}'

# S3 User credentials
minio_users:
  - access_key: '{{ s3_lake_reader }}'
    secret_key: '{{ s3_lake_reader_secret }}'
  - access_key: '{{ s3_lake_writer }}'
    secret_key: '{{ s3_lake_writer_secret }}'
  - access_key: '{{ s3_loki_writer }}'
    secret_key: '{{ s3_loki_writer_secret }}'

# User mapping
minio_credentials:
  - name: '{{ s3_lake_reader }}-creds'
  - name: '{{ s3_lake_writer }}-creds'
  - name: '{{ s3_loki_writer }}-creds'

# IAM Policy definitions
minio_policies:
  - name: lake-r
    actions:
      - s3:GetObject
      - s3:GetBucketLocation
      - s3:ListBucket
    resources:
      - 'arn:aws:s3:::{{ lake_bucket }}'
      - 'arn:aws:s3:::{{ lake_bucket }}/*'
    user: '{{ s3_lake_reader }}'
  - name: lake-rw
    actions:
      - s3:*
    resources:
      - 'arn:aws:s3:::{{ lake_bucket }}'
      - 'arn:aws:s3:::{{ lake_bucket }}/*'
      - 'arn:aws:s3:::{{ scratch_bucket }}'
      - 'arn:aws:s3:::{{ scratch_bucket }}/*'
    user: '{{ s3_lake_writer }}'
  - name: loki-rw
    actions:
      - s3:*
    resources:
      - 'arn:aws:s3:::{{ loki_chunks_bucket }}'
      - 'arn:aws:s3:::{{ loki_chunks_bucket }}/*'
      - 'arn:aws:s3:::{{ loki_ruler_bucket }}'
      - 'arn:aws:s3:::{{ loki_ruler_bucket }}/*'
      - 'arn:aws:s3:::{{ loki_admin_bucket }}'
      - 'arn:aws:s3:::{{ loki_admin_bucket }}/*'
    user: '{{ s3_loki_writer }}'

# OIDC configuration
minio_oidc_enabled: true

# Wait times and retries
minio_wait_retries: 60
minio_wait_delay: 5
minio_bootstrap_wait_retries: 30
minio_bootstrap_wait_delay: 10
